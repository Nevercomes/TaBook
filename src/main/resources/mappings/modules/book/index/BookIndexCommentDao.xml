<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nevercome.tabook.modules.book.dao.index.BookIndexCommentDao">

    <sql id="commentColumns">
        a.id AS "bookCommentId",
        a.title,
        a.content_digest,
        a.cover
    </sql>

    <sql id="studentColumns">
        u.name AS "authorName",
        u.avatar_url AS "authorAvatar",
        stu.id AS "studentId",
        stu.school_name AS "schoolName"
    </sql>

    <sql id="statisticsColumns">
        (SELECT COUNT(1)
         FROM book_like_record t
         WHERE t.refer_id = a.id AND t.del_flag = '0') AS "likeNum",
        ( SELECT COUNT(1) FROM book_comment_reply t WHERE t.book_comment_id = a.id AND t.del_flag = '0') AS "replyNum"
    </sql>

    <sql id="bookIndexCommentJoins">
        INNER JOIN book_user_info stu ON stu.id = a.student_id
        INNER JOIN sys_user u ON u.id = stu.user_id
    </sql>

    <select id="findList" resultType="BookIndexComment">
        SELECT
        <include refid="commentColumns"/>,
        <include refid="studentColumns"/>,
        <include refid="statisticsColumns"/>
        FROM book_comment_long a
        <include refid="bookIndexCommentJoins"/>
        <where>
            a.del_flag = '0'
        </where>
        <choose>
            <when test="page != null and page.orderBy != null and page.orderBy != ''">
                ORDER BY #{page.orderBy}
            </when>
            <otherwise>
                ORDER BY a.create_time DESC
            </otherwise>
        </choose>
    </select>

</mapper>